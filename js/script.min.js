!function(){"use strict";async function e(e){let a=await fetch(e);return await a.json()}function a(e){let a=new Image;return new Promise(((r,i)=>{a.onload=()=>{r(a)},a.src=e}))}let r=document.querySelector("tbody"),i=document.querySelector("canvas#roomPreviewCanvas"),t=document.querySelector("audio"),o=document.querySelector("#playAnimation"),n=document.querySelector("#tickAnimation"),s=i.getContext("2d");async function l({visible:e,src:r,posX:t=0,posY:o=0,originX:n=0,originY:l=0,frameX:m=0,frameY:c=0,frameRegX:f=0,frameRegY:u=0,frameW:d=0,frameH:y=0,alpha:g=1}){if(!1===e)return;if("canvas"==r)return i.width=d,void(i.height=y);let p=i.images[r];p||(p=i.images[r]=await a(r)),s.globalAlpha=g,s.drawImage(p,m-f,c-u,d,y,t-n,o-l,d,y)}function m(e){e.frameNo%=e.frames.length;let a=e.frames[e.frameNo];Object.assign(e,{src:e.images[a[4]],frameX:a[0],frameY:a[1],frameRegX:a[5],frameRegY:a[6],frameW:a[2],frameH:a[3]})}function c(){if(i.layers){for(let e of i.layers)e.frameNo&&(e.frameNo++,m(e));f()}}async function f(){for(let e of i.layers)await l(e)}function u(){function e(e,a,r,i){let t=document.createElement("input");return e.insertCell().appendChild(t),t.disabled=null==r||"canvas"==r,t.id=t.name=a,t.type=i,"checkbox"==i?t.checked="boolean"!=typeof r||r:t.value=r,Object.defineProperty(e.layer,a,{get:()=>"checkbox"==t.type?t.checked:t.value,set(e){"checkbox"==t.type?t.checked="boolean"!=typeof e||e:t.value=e}}),t.onchange=function(){this.layer[this.id]="checkbox"==this.type?this.checked:this.value,console.log(this.id,this.layer),"frameNo"==this.id&&m(this.layer),f()},t}function a(a){let{immoveable:i,visible:t,src:o,posX:n,posY:s,originX:l,originY:m,frameNo:c,frameX:f,frameY:u,frameRegX:d,frameRegY:y,frameW:g,frameH:p}=a,h=r.insertRow();return h.layer=a,i&&h.classList.add("immoveable"),function(e,a){let r=document.createElement("div"),i=e.insertCell();i.appendChild(r),i.classList.add("drag-widget"),a||r.classList.add("burger")}(h,i),e(h,"visible",t,"checkbox").layer=a,e(h,"src",o,"url").layer=a,e(h,"posX",n,"number").layer=a,e(h,"posY",s,"number").layer=a,e(h,"originX",l,"number").layer=a,e(h,"originY",m,"number").layer=a,e(h,"frameNo",c,"number").layer=a,e(h,"frameX",f,"number").layer=a,e(h,"frameY",u,"number").layer=a,e(h,"frameRegX",d,"number").layer=a,e(h,"frameRegY",y,"number").layer=a,e(h,"frameW",g,"number").layer=a,e(h,"frameH",p,"number").layer=a,h}r.innerHTML="";for(let e of i.layers)a(e);sortable("#layers",{items:":not(.immoveable)"})[0].addEventListener("sortstop",(function(e){i.layers=[].map.call(r.rows,(e=>e.layer)),f()}))}async function d(){let{value:a,room:r}=this.selectedOptions[0];console.log(a,r),i.room=r,i.layers=[],this.frame||(this.frame=0),i.layers.push({immoveable:!0,src:"canvas",frameW:r.width,frameH:r.height});let o=r.spriteSheet="string"==typeof r.spriteSheet?await e(r.spriteSheet):r.spriteSheet,n=r.layout;if(r.media.background&&i.layers.push({visible:!0,src:r.media.background,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height}),t.src=r.media.music||"",n&&(Array.isArray(n.playground)&&Array.isArray(n.playground[0])&&(n.playground=[].concat.apply([],n.playground)),n.playground.sort(((e,a)=>e.y-a.y))),n.playground.sort(((e,a)=>e.y-a.y)),n&&o.images)for(let e in n.playground){let a=n.playground[e];if(void 0===a){console.log(`Playground ${e} has no placement`);continue}let r=o.animations[a.id];if(void 0===r){console.log(`Playground ${e},placement ${a.id} has no animation`);continue}let t={images:o.images,frames:r.frames.map((e=>o.frames[e])),visible:!0,posX:a.x,posY:a.y,originX:a.regX,originY:a.regY,frameNo:0};m(t),i.layers.push(t)}r.media.foreground&&i.layers.push({visible:!0,src:r.media.foreground,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height}),r.media.navMesh&&i.layers.push({visible:!1,src:r.media.navMesh,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height,alpha:.5}),r.media.treasure&&i.layers.push({visible:!1,src:r.media.treasure,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height,alpha:.5}),u(),f()}async function y(){let a=document.getElementById("select-room"),r=await async function(a){let r=await e("https://api.boxcrittersmods.ga/manifests");return await e(r[a].src)}("rooms");for(var i of(a.addEventListener("change",d),r)){i.roomId=i.roomId||i.id,i.name=i.name||i.roomId;let e=document.createElement("option");e.value=i.roomId,e.text=i.name,e.room=i,a.add(e,null)}d.call(a)}i.images={},i.fps=60,Object.defineProperty(i,"animating",{get:()=>o.classList.contains("enabled")}),requestAnimationFrame((function e(){setTimeout((function(){requestAnimationFrame(e),i.animating&&c()}),1e3/i.fps)})),n.addEventListener("click",c),setTimeout((()=>{y()}),10)}();
//# sourceMappingURL=script.min.js.map