!function(){"use strict";async function e(e){let a=await fetch(e);return await a.json()}function a(e){let a=new Image;return new Promise(((r,t)=>{a.onload=()=>{r(a)},a.src=e}))}let r=document.querySelector("tbody"),t=document.querySelector("canvas#roomPreviewCanvas"),i=document.querySelector("canvas#layerPreview"),o=document.querySelector("audio"),n=document.querySelector("#playAnimation"),s=document.querySelector("#tickAnimation"),l=t.getContext("2d"),m=i.getContext("2d");async function c({visible:e,src:r,posX:i=0,posY:o=0,originX:n=0,originY:s=0,frameX:m=0,frameY:c=0,frameRegX:d=0,frameRegY:f=0,frameW:u=0,frameH:g=0,alpha:y=1}){if(!1===e)return;if("canvas"==r)return t.width=u,void(t.height=g);let p=t.images[r];p||(p=t.images[r]=await a(r)),l.globalAlpha=y,l.drawImage(p,m-d,c-f,u,g,i-n,o-s,u,g)}async function d({src:e,frameX:r=0,frameY:o=0,frameRegX:n=0,frameRegY:s=0,frameW:l=0,frameH:c=0}){let d=l,f=c,u=d/f;f>400&&(d=400*u,f=400),d>400&&(f=400/u,d=400),i.height=f,i.width=d;let g=t.images[e];g||(g=t.images[e]=await a(e)),m.drawImage(g,r-n,o-s,l,c,0,0,d,f)}function f(e){e.frameNo%=e.frames.length;let a=e.frames[e.frameNo];Object.assign(e,{src:e.images[a[4]],frameX:a[0],frameY:a[1],frameRegX:a[5],frameRegY:a[6],frameW:a[2],frameH:a[3]})}function u(){if(t.layers){for(let e of t.layers)e.frameNo&&(e.frameNo++,f(e));g()}}async function g(){for(let e of t.layers)e.previewing&&await d(e),await c(e)}function y(){function e(e,a,r,t){let i=document.createElement("input");return e.insertCell().appendChild(i),i.disabled=null==r||"canvas"==r,i.id=i.name=a,i.type=t,"checkbox"==t?i.checked="boolean"!=typeof r||r:i.value=r,Object.defineProperty(e.layer,a,{get:()=>"checkbox"==i.type?i.checked:i.value,set(e){"checkbox"==i.type?i.checked="boolean"!=typeof e||e:i.value=e}}),i.onchange=function(){this.layer[this.id]="checkbox"==this.type?this.checked:this.value,console.log(this.id,this.layer),"frameNo"==this.id&&f(this.layer),g()},i}function a(a){let{immoveable:t,visible:o,src:n,posX:s,posY:l,originX:m,originY:c,frameNo:f,frameX:u,frameY:g,frameRegX:y,frameRegY:p,frameW:h,frameH:v}=a,b=r.insertRow();return b.layer=a,t&&b.classList.add("immoveable"),function(e,a){let r=document.createElement("div"),t=e.insertCell();t.appendChild(r),t.classList.add("drag-widget"),a||r.classList.add("burger")}(b,t),e(b,"visible",o,"checkbox").layer=a,e(b,"src",n,"url").layer=a,e(b,"posX",s,"number").layer=a,e(b,"posY",l,"number").layer=a,e(b,"originX",m,"number").layer=a,e(b,"originY",c,"number").layer=a,e(b,"frameNo",f,"number").layer=a,e(b,"frameX",u,"number").layer=a,e(b,"frameY",g,"number").layer=a,e(b,"frameRegX",y,"number").layer=a,e(b,"frameRegY",p,"number").layer=a,e(b,"frameW",h,"number").layer=a,e(b,"frameH",v,"number").layer=a,b.addEventListener("mouseenter",(e=>{d(a),b.layer.previewing=!0,i.classList.remove("hide")})),b.addEventListener("mousemove",(e=>{let a=0*-parseFloat(window.getComputedStyle(i).width),r=-parseFloat(window.getComputedStyle(i).height)/2;i.style.left=e.pageX+a+"px",i.style.top=e.pageY+r+"px"})),b.addEventListener("mouseleave",(e=>{i.classList.add("hide"),b.layer.previewing=!1})),b}r.innerHTML="";for(let e of t.layers)a(e);sortable("#layers",{items:":not(.immoveable)"})[0].addEventListener("sortstop",(function(e){t.layers=[].map.call(r.rows,(e=>e.layer)),g()}))}async function p(){let{value:a,room:r}=this.selectedOptions[0];console.log(a,r),t.room=r,t.layers=[],this.frame||(this.frame=0),t.layers.push({immoveable:!0,src:"canvas",frameW:r.width,frameH:r.height});let i=r.spriteSheet="string"==typeof r.spriteSheet?await e(r.spriteSheet):r.spriteSheet,n=r.layout;if(r.media.background&&t.layers.push({visible:!0,src:r.media.background,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height}),o.src=r.media.music||"",n&&(Array.isArray(n.playground)&&Array.isArray(n.playground[0])&&(n.playground=[].concat.apply([],n.playground)),n.playground.sort(((e,a)=>e.y-a.y))),n.playground.sort(((e,a)=>e.y-a.y)),n&&i.images)for(let e in n.playground){let a=n.playground[e];if(void 0===a){console.log(`Playground ${e} has no placement`);continue}let r=i.animations[a.id];if(void 0===r){console.log(`Playground ${e},placement ${a.id} has no animation`);continue}let o={images:i.images,frames:r.frames.map((e=>i.frames[e])),visible:!0,posX:a.x,posY:a.y,originX:a.regX,originY:a.regY,frameNo:0};f(o),t.layers.push(o)}r.media.foreground&&t.layers.push({visible:!0,src:r.media.foreground,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height}),r.media.navMesh&&t.layers.push({visible:!1,src:r.media.navMesh,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height,alpha:.5}),r.media.treasure&&t.layers.push({visible:!1,src:r.media.treasure,posX:0,posY:0,originX:0,originY:0,frameW:r.width,frameH:r.height,alpha:.5}),y(),g()}async function h(){let a=document.getElementById("select-room"),r=await async function(a){let r=await e("https://api.boxcrittersmods.ga/manifests");return await e(r[a].src)}("rooms");for(var t of(a.addEventListener("change",p),r)){t.roomId=t.roomId||t.id,t.name=t.name||t.roomId;let e=document.createElement("option");e.value=t.roomId,e.text=t.name,e.room=t,a.add(e,null)}p.call(a)}t.images={},t.fps=60,Object.defineProperty(t,"animating",{get:()=>n.classList.contains("enabled")}),requestAnimationFrame((function e(){setTimeout((function(){requestAnimationFrame(e),t.animating&&u()}),1e3/t.fps)})),s.addEventListener("click",u),setTimeout((()=>{h()}),10)}();
//# sourceMappingURL=script.min.js.map